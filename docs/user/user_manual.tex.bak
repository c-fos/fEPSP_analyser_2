\documentclass[12pt,a4paper]{report}
\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}
\usepackage[T2A]{fontenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{makeidx}
\usepackage{graphicx}
\usepackage[left=2cm,right=2cm,top=2cm,bottom=2cm]{geometry}
%%% позиционирование плавающих объектов%%%
\usepackage[section]{placeins}
%%% Гиперссылки %%%
%\usepackage[linktocpage=true,plainpages=false,pdfpagelabels=false]{hyperref}

\author{Malakhin Ilya}
\title{\huge{FEPSP\_ANALYSER}\\ \large{Пользовательская документация\\ Версия 0.2.0}}
\begin{document}
\maketitle
\chapter{Общее описание программы}
Программа "fEPSP\_analyser" позволяет в полностью автоматизированном режиме рассчитывать амплитуду спайков, присутствующих в записи нейрональной активности, сделанной в программе Ins6. 

Работа программы проходит в несколько этапов. Сначала пользователь указывает папку (\textit{эксперимент}) с .dat и .inf файлами (\textit{записями}) которые по очереди обрабатываются программой и посчитанные для каждой записи данные (количество стимулов, количество спайков на каждый стимул, амплитуда сапайков и т.д.) сохраняются в базу данных (\textit{БД}). На втором этапе пользователь экспортирует из БД данные интересующего его эксперимента. Экспорт осуществляется в текстовый файл в простом виде "Название файла - время - амплитуда". При этом в БД хранится значительно больше информации и при необходимости могут быть добавлены другие типы экспорта.

Ключевыми элементами алгоритма обработки экспериментальных записей являются фильтрация сигнала с использованием стационарного вейвлет разложения и использование нейронных сетей для поиска электрических стимулов и спайков.
\chapter{Установка}
\section{Зависимости}
Программа написана на языке Python 2.7, работает в ОС Linux и на данный момент имеет следующие зависимости:
\begin{itemize}
\item СУБД MySQL 5.1.70 (Используемый интерфейс БД, абстрагированный от конкретной реализации БД позволяет работать с любой реляционной БД)
\item GNU R 3.0.1 с установленным модулем nnet любой версии.
\item Ряд модулей Python:
\begin{itemize}
\item PyQt4 4.10.2 - Графический интерфейс
\item matplotlib 1.3.0 - Отрисовка графиков
\item numpy 1.7.1 - Математические операции
\item pywt (PyWavelets) 0.2.2-r1 - вейвлет преобразования  
\item rpy2 2.3.8 - интерфейс из Python к R
\item scipy 0.13.0 - высокоуровневые математические операции
\item sqlalchemy 0.8.2-r1 - Интерфейс в СУБД
\end{itemize}
\end{itemize}
Работа программы возможна и с другими мажорными версиями пакетов, но не гарантируется.

Для удобной установки и обновления самой программы следует установить Git любой версии.
\section{Установка}
\begin{itemize}
\item В любую пользовательскую директорию доступную для записи клонируется master ветка git репозитория с адреса: \textit{http://github.com/c-fos/fEPSP\_analyser\_2}.
\item Устанавливаются перечисленные в зависимостях пакеты
\item Настраиваются MySQL сервер, R, редактируются жестко прописанные пути в файлах rInterface\_lib.py и simple.py
\end{itemize}

\section{Обновление}
Выполнить в терминале находясь в директории программы команду `git fetch`.

\chapter{Настройка}
\section{Настройка MySQL}
После установки MySQL требуется создать схему (по умолчанию fepsp\_db) и пользователя (по умолчанию fepsp\_user с паролем filter123) с полными правами на эту схему. В случае использования других имен, следует отредактировать строку настроек БД в файле dbAccess\_lib\_2.py.
Сервер БД должен быть запущен во время работы fEPSP\_analyser`а.
\section{Настройка R}
После установки R необходимо запустить интерпретатор R и установить пакет nnet выполнив команду install.packages('nnet'). Следует убедится что в файле rInterface\_lib.py прописаны верные пути до директории с библиотеками R.
\section{Настройка программы}
Открыть интерпретатор Python из директории программы, импортировать модуль dbModel.py ("import dbModel"), выполнить команду ('dbModel.createDB()'). 
\section{Настройка нейронных сетей}
На данный момент пользовательский интерфейс для обучения нейронных сетей не реализован.

{\small Обучение выполняется из среды R с использованием скриптов. Обучающая выборка извлекается из БД и на уровне БД требуется исключить или отредактировать ошибочные данные. После миграции с нейронных сетей реализованных в R на сети созданные в PyBrain переобучение нейронных сетей будет реализовано из пользовательского интерфейса.}
\chapter{Расчет}
\section{Требования к данным}
Расчет выполняется над папкой с файлами (.dat и .ins). Для успешного расчета необходимо выполнение следующих требований:
\begin{itemize}
\item Директория с файлами перенесена с компьютера на котором выполнялась запись без потери информации о времени модификации файла. Надо убедится что время изменения файлов соответствует времени создания исходных файлов т.е. времени реальной подачи стимула и записи нейрональной активности. Копирование с Win98 на флеш-карту выполняется с сохранением данной информации. Если при копировании с флеш-карты на компьютер где будет выполнятся расчет это время перезаписывается временем копирования, то для копирования следует использовать команду \textbf{cp} с флагом \textit{--preserve}
\item Названия папки позволяет идентифицировать к какому эксперименту относятся записи содержащиеся в ней
\item Названия файлов позволят идентифицировать к какому этапу эксперимента относится та или иная запись
\end{itemize}
\section{Описание пользовательского интерфейса}
Программа запускается командой `\emph{python fEPSP\_gui.py}` из папки "\emph{путь по которому клонировали репозиторий/fEPSP\_analyser\_new/main}".
После запуска поднимается графический пользовательский интерфейс программы Рис.\ref{fig:analyse}.

Пользовательский интерфейс представлен одним окном с четырьмя вкладками.
\begin{itemize}
\item Расчет - Вкладка для настройки и запуска анализа над конкретным экспериментом. Риc.\ref{fig:analyse}
\item Удаление - Вкладка позволяющая выбрать один из обработанных экспериментов и удалить его из базы. Рис.\ref{fig:delete}
\item Экспорт - Вкладка для экспорта в формат .csv обработанных данных (простое представление \textbf{Имя файла-Амплитуда спайка}). Рис.\ref{fig:export}
\item Настройка - Вкладка для настройки соединения с БД. Рис.\ref{fig:config}
\end{itemize}
\newpage
\subsection{Вкладка "Расчет"}
\begin{figure}[h!]
\vspace{-5pt}
	\center{	\includegraphics[width=14cm,keepaspectratio=true]{img/analyse.png} }\\
 \caption{Пользовательский интерфейс. Вкладка расчет.}
\label{fig:analyse}
\end{figure}

\textbf{Path} - Адресная строка в которой указывается путь до папки с .dat файлами.\\
\textbf{Frequency} - Значение по умолчанию частоты с которой была выполнена запись. Алгоритм сначала считывает значение частоты из .ins файла, если это не удается, то будет использовано значение по умолчанию.\\
\textbf{Tags} - Поля для перечисление ключевых слов (тэгов), которые будут привязаны к обработанному эксперименту. Теги указывать не обязательно, но они позволяют группировать обработанные эксперименты и могут облегчит идентификацию экспериментов. Тэги перечисляются через запятую. Один тег может быть привязан к любому количеству обработанных экспериментов, также как и эксперимент может иметь произвольное количество тэгов.\\
\textbf{Write to database} - флаг определяющий будут ли записаны данные в БД или в результате анализа будет только создан .png файл с изображением сигнала и найденных спайков.\\
 {\small В настоящий момент в связи с переходом на sqlalchemy флаг работает не корректно и снимать его не рекомендуется.}\\
\textbf{Debug} - Флаг определяющий насколько подробно будут выводится сообщения о работе программы в терминал. При поднятом флаге в терминал выводятся все сообщения, при опущенном только сообщения об ошибках. Независимо от состояния флага во время расчета формируется файл fEPSP.log в дирректории программы с подробным логом.\\
\textbf{Manual fibre search} - Ручное определение волоконных ответов. При поднятом флаге при обработке каждой записи будет появляться всплывающее окно с изображением сигнала и найденных спайков. В случае если волоконный ответ определился как спайк по нему следует кликнуть правой кнопкой мыши и он будет переопределен как волоконный ответ.\\ {\small В настоящий момент данный функционал работает не корректно, пофиксю в ближайшее время.}\\
\textbf{Start} - Запуск расчета.\\
\textbf{Smooth coefficient} - коэффициент сглаживания. 7 является эмпирически подобранным значением, но в случае если сигнал избыточно сглажен коэффициент можно уменьшить на 1, а если сглажен недостаточно, то увеличить на 1.\\
\subsection{Вкладка "Удаление"} 
\begin{figure}[h!]
\vspace{-5pt}
	\center{	\includegraphics[width=14cm,keepaspectratio=true]{img/delete.png} }\\
 \caption{Пользовательский интерфейс. Вкладка удаление.}
\label{fig:delete}
\end{figure}

\textbf{Refresh} - загрузить список обработанных экспериментов из БД. После загрузки в поле слева от кнопки "Refresh" следует выбрать эксперимент для удаления.
\textbf{Delete saved source data end results} - Удалить из БД эксперимент целиком: метаданные, исходный массив, посчитанные данные.\\
\textbf{Delete results only} - Удалить только посчитанные данные, сохранив методанные (дату, время, теги, названия) и исходные данные (при расчете числовой массив из .dat файла сохраняется в БД).\\ {\small На данный момент бесполезно, поскольку еще не реализована возможность выполнять расчет с использованием сохраненных в БД исходных данных.}\\
\textbf{Delete} - Удалить выбранный эксперимент.\\
\newpage
\subsection{Вкладка "Экспорт"}
\begin{figure}[h!]
\vspace{-5pt}
	\center{	\includegraphics[width=14cm,keepaspectratio=true]{img/export.png} }\\
 \caption{Пользовательский интерфейс. Вкладка экспорт.}
\label{fig:export}
\end{figure}
\textbf{Refresh} - загрузить список обработанных экспериментов из БД. После загрузки в поле слева от кнопки "Refresh" следует выбрать эксперимент для экспорта.
\textbf{Spike number} - Выбор интересующего спайка. 0 - волоконный ответ, 1 - первый реальный спайк.\\
\textbf{Filename} - Имя текстового файла в который будут записаны данные. Файл будет создан в папке с программой. Название можно писать как с расширением, так и без.\\
\textbf{Export} - Запуск экспорта.\\
\newpage
\subsection{Вкладка "Настройка"}
\begin{figure}[h!]
\vspace{-5pt}
	\center{	\includegraphics[width=14cm,keepaspectratio=true]{img/config.png} }\\
 \caption{Пользовательский интерфейс. Вкладка настройка.}
\label{fig:config}
\end{figure}

\textbf{Server adress} - адрес сервера БД. IP-адрес или localhost, если сервер запущен на локальном компьютере.\\
\textbf{Database name} - Название схемы в базе данных.\\
\textbf{User Name} - Имя пользователя схемы.\\
\textbf{Password} - Пароль пользователя схемы.\\   
\newpage
\section{Запуск расчета}
\begin{enumerate}
\item В адресной строке указываем полный путь до папки с .dat и .ins файлами. Для этого либо прописываем путь в адресной строке вручную, либо для перехода по дереву каталогов можно пользоваться панелью слева. Для перехода внутрь папки кликаем два раза на папку в левой панели, а для перехода на уровень выше есть кнопка справа от адресной строки. Показателем того что путь указан верно является список .dat и .ins файлов в панели слева.
\item Выбрав папку, в поле "Tags" указываем через запятую ключевые слова, которые помогут в дальнейшем анализировать посчитанные данные. Тэги можно и не указывать, но они позволяют группировать посчитанные данные и могут облегчить идентификацию экспериментов.
\item При необходимости меняем частоту по умолчанию (частота определяется из файла .ins, но если это не удалось, то используется умолчательная).
\item Нажимаем кнопку "Start".
\end{enumerate}

\section{Результат расчета}
В результате расчета будут добавлены:
\begin{itemize}
\item В БД - записи об обработанной папке (эксперименте), записях и характеристиках найденных спайков.
\item В папку к .dat файлам - файлы \$ИМЯ\_ФАЙЛА.dat\_graph.png с изображением необработанного сигнала, сглаженного сигнала, найденных спайков. 
\item В папку с программой - лог расчета в файле fEPSP.log
\end{itemize}

На данный момент амплитуда спайков записывается не в мВ,а в делениях АЦП (также как и в .dat файлах INS6). Соответственно она может быть переведена в мВ также как это делается в шаблоне EXCEL.

Для того чтобы получить привычное представление обработанных данных в виде "Название файла - Время - Амплитуда спайка" нужно перейти на вкладку "Экспорт" и выполнить экспорт в текстовый файл посчитанных данных.

\chapter{Экспорт}
\section{Настройка и запуск экспорта}
Результат расчета в упрощенном численном виде может быть выгружен из БД. Для этого нужно:
\begin{enumerate}
\item На вкладке "Export" нажать кнопку "Refresh"
\item В окне слева от кнопки "Export" выбрать название интересующего эксперимента (берется с имени обработанной папки)
\item Указать номер спайка амплитуду какого нужно выгружать (0-волоконный ответ, 1-первый реальный спайк, 2-второй и т.д.)
\item Указать полное имя текстового файла (с расширением или без)
\item Нажать кнопку "Export".
\end{enumerate}

\section{Результат экспорта}
В результате будет создан текстовый файл следующей структуры:\\
\begin{tabular}{|p{4.5cm}|p{12cm}|}
\hline 
Название эксперимента & Название эксперимента которому принадлежит запись, название берется с имени папки \\ 
\hline 
Имя файла & Имя обработанной записи без расширения \\ 
\hline 
Номер спайка & Порядковый номер спайка в ответ на первый стимул в проанализированной записи \\ 
\hline 
Время изменения файла & Предполагается что файл изменяется только при первоначальной записи, соответственно это время соответствует времени подачи стамула \\ 
\hline 
Амплитуда & Амплитуда спайка в делениях АЦП (также как в .dat файле) \\ 
\hline 
\end{tabular}
\\

Далее этот файл может быть открыт из Excel. Значения колонок разделены запятыми, десятичным разделителем является точка.
\chapter{Планы}
Планы дальнейшей работы над программой fEPSP\_analyser в порядке приоритета.\\
\begin{tabular}{|c|p{3cm}|p{6cm}|p{4cm}|p{2cm}|}
\hline 
1 & Переход с R на PyBrain, переобучение сетей &  Качественно новый уровень работы с нейронными сетями. & Необходимый этап для дальнейших изменений. & Конец декабря 2013 \\ 
\hline 
2 & Переработка алгоритма сглаживания & Переработка запутанных и вероятно неоптимальных формул, возможно переход на нейронные сети для подбора характеристик фильтров & повышение качества сглаживания, прозрачность алгоритма & январь-февраль 2014 \\ 
\hline 
3 & Алгоритм оценки качества & численная оценка качества сглаживания и поиска стимулов/спайков & необходим для следующего этапа & январь-апрель 2014 \\ 
\hline 
4 & Автоматизация переобучения нейронных сетей & Повышение всех связанных с сетями характеристик анализа & Повышение качества анализа & весна-лето 2014 \\ 
\hline 
\end{tabular}

Кроме этого по возможности будут исправляться ошибки, пополнятся пользовательская и техническая документация, может и до внешнего вида пользовательского интерфейса руки дойдут.
\chapter{Здесь мог бы быть FAQ}
По мере поступления вопросов раздел будет пополнятся.
\begin{itemize}
\item Что-то не работает (работает не так), что делать? - Дать мне об этом знать, пока я не буду знать о проблеме я её врятли решу. Писать на почту pilat1988@gmail.com. Время ответа на письмо сутки, время исправления дефекта от одного вечера до недели в зависимости от дефекта и загруженности. 
\end{itemize}
\chapter{Список сокращений и используемых терминов}
\textbf{БД} - база данных.\\
\textbf{Спайк} - синхронный ответ популяции нейронов на тестирующий стимул зарегистрированный внеклеточно и проявляющийся в изменении электрического потенциала на регистрирующем микроэлектроде.\\
\textbf{Ответ} - один или несколько спайков в ответ на единичный тестирующий стимул.\\
\textbf{Запись} - файл *.dat сформированный программой ins6 и являющийся числовым массивом описывающим изменение электрического потенциала на регистрирующем микроэлектроде от времени.\\
\textbf{Эксперимент} - совокупность записей полученная в рамках одного эксперимента и помещенная в одну директорию.
 
\end{document}